generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  coach
  admin
}

enum UserStatus {
  active
  inactive
}

enum SessionStatus {
  scheduled
  completed
  cancelled
}

enum EmailStatus {
  success
  failed
}

model User {
  id               String    @id @default(cuid())
  employeeNumber   String    @unique
  name             String
  email            String    @unique
  role             UserRole  @default(coach)
  passwordHash     String
  status           UserStatus @default(active)
  googleRefreshToken String?  @db.Text
  googleCalendarId   String?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  students         Student[] @relation("UserStudents")
  coachedSessions  Session[] @relation("CoachSessions")
}

model Student {
  id               String    @id @default(cuid())
  name             String
  email            String
  note             String?
  createdByUserId  String
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  createdByUser    User      @relation("UserStudents", fields: [createdByUserId], references: [id])
  sessions         Session[]

  @@index([createdByUserId, email])
}

model Session {
  id          String        @id @default(cuid())
  studentId   String
  coachId     String
  startAt     DateTime
  endAt       DateTime
  status      SessionStatus @default(scheduled)
  meetUrl     String
  externalId  String?
  title       String?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  student     Student       @relation(fields: [studentId], references: [id])
  coach       User          @relation("CoachSessions", fields: [coachId], references: [id])
  emailLogs   EmailLog[]

  @@index([coachId, startAt])
}

model EmailLog {
  id           String       @id @default(cuid())
  sessionId    String
  toEmail      String
  subject      String
  body         String
  status       EmailStatus
  errorMessage String?
  sentAt       DateTime      @default(now())
  session      Session       @relation(fields: [sessionId], references: [id])

  @@index([sessionId])
}
